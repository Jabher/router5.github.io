!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("router5",["exports"],e):e(t.router5=t.router5||{})}(this,function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){return Array.isArray(e)?e.map(function(e){return n(t,e)}).join("&"):e===!0?t:t+"="+e}function r(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function a(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t){function e(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],u=t.getState();return!!u&&(o||u.name===e?n(t.makeState(e,a),u,i):r(t.makeState(e,a),u))}function n(e,n){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(e.name!==n.name)return!1;var a=function(e){return t.rootNode.getSegmentsByName(e).map(function(t){return t.parser[r?"urlParams":"params"]}).reduce(function(t,e){return t.concat(e)},[])},o=a(e.name),i=a(n.name);return o.length===i.length&&o.every(function(t){return e.params[t]===n.params[t]})}function r(t,e){var n=new RegExp("^"+t.name+"\\.(.*)$");return!!n.test(e.name)&&Object.keys(t.params).every(function(n){return t.params[n]===e.params[n]})}function a(e,n){if(e===J.UNKNOWN_ROUTE)return n.path;var r=c.useTrailingSlash;return t.rootNode.buildPath(e,n,{trailingSlash:r})}function o(e,n){return t.rootNode.buildState(e,n)}function i(e,n){var r=c.trailingSlash,a=c.strictQueryParams,o=c.strongMatching,i=t.rootNode.matchPath(e,{trailingSlash:r,strictQueryParams:a,strongMatching:o});if(i){var u=i.name,s=i.params,l=i._meta,f=void 0===c.useTrailingSlash?e:t.buildPath(u,s);return t.makeState(u,s,f,l,n)}return null}function u(e){t.rootNode.setPath(e)}var c=t.getOptions();t.isActive=e,t.areStatesEqual=n,t.areStatesDescendants=r,t.buildPath=a,t.buildState=o,t.matchPath=i,t.setRootPath=u}function i(t){function e(){return a}function n(){var e,n=(e=arguments.length-1,arguments.length<=e?void 0:arguments[e]),r="function"==typeof n?n:tt,i="function"!=typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:void 0;if(a)return r({code:Y.ROUTER_ALREADY_STARTED}),t;var u=void 0,c=void 0;a=!0,t.invokeEventListeners(J.ROUTER_START);var s=function(e,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e||t.invokeEventListeners(J.TRANSITION_SUCCESS,n,null,{replace:!0}),e&&a&&t.invokeEventListeners(J.TRANSITION_ERROR,n,null,e),r(e,n)};return void 0!==i||o.defaultRoute?("string"==typeof i?u=i:"object"===("undefined"==typeof i?"undefined":X(i))&&(c=i),c?(t.setState(c),s(null,c)):!function(){c=void 0===u?null:t.matchPath(u);var e=function(){return t.navigateToDefault({replace:!0},r)},n=function(e){return t.navigate(e.name,e.params,{replace:!0,reload:!0},r)};c?t.transitionToState(c,t.getState(),{},function(t,r){t?t.redirect?n(t.redirect):o.defaultRoute?e():s(t,null,!1):s(null,r)}):o.defaultRoute?e():o.allowNotFound?s(null,t.makeNotFoundState(u)):s({code:Y.ROUTE_NOT_FOUND,path:u},null)}(),t):s({code:Y.NO_START_PATH_OR_STATE})}function r(){return a&&(t.setState(null),a=!1,t.invokeEventListeners(J.ROUTER_STOP)),t}var a=!1,o=t.getOptions();t.isStarted=e,t.start=n,t.stop=r}function u(t){return t.split(".").reduce(function(t,e){return t.concat(t.length?t[t.length-1]+"."+e:e)},[])}function c(t){return void 0!==t&&null!==t}function s(t){return t&&t.meta&&t.meta.params}function l(t,e){return c(e.meta.params[t])?Object.keys(e.meta.params[t]).reduce(function(t,n){return t[n]=e.params[n],t},{}):{}}function f(t,e){function n(){var n=void 0,i=function(){var o=r[n],i=a[n];if(o!==i)return{v:n};var u=l(o,t),c=l(i,e);if(u.length!==c.length)return{v:n};if(0===u.length)return"continue";var s=Object.keys(u).some(function(t){return c[t]!==u[t]});return s?{v:n}:void 0};for(n=0;n<o;n+=1){var u=i();switch(u){case"continue":continue;default:if("object"===("undefined"==typeof u?"undefined":et(u)))return u.v}}return n}var r=e?u(e.name):[],a=u(t.name),o=Math.min(r.length,a.length),i=void 0;e?s(e)||s(t)?i=n():(console.warn("[router5.transition-path] Some states are missing metadata, reloading all segments"),i=0):i=0;var c=r.slice(i).reverse(),f=a.slice(i),h=e&&i>0?r[i-1]:"";return{intersection:h,toDeactivate:c,toActivate:f}}function h(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function v(t,e,n){var r=e.isCancelled,a=e.toState,o=e.fromState,i=e.errorKey,u=Array.isArray(t)?t:Object.keys(t),c=function(t){return"object"===("undefined"==typeof t?"undefined":rt(t))&&void 0!==t.name&&void 0!==t.params&&void 0!==t.path},s=function(t){return t.name!==a.name||t.params!==a.params||t.path!==a.path},l=function(e){if(!u.length)return!0;var n="string"==typeof u[0],c=i&&n?h({},i,u[0]):{},s=n?t[u[0]]:u[0],l=s.call(null,a,o,e);return r()?e(null):"boolean"==typeof l?e(l?null:c):l&&"function"==typeof l.then&&l.then(function(t){t instanceof Error?e({error:t},null):e(null,t)},function(t){t instanceof Error?(console.error(t.stack||t),e(nt({},c,{promiseError:t}),null)):e("object"===("undefined"==typeof t?"undefined":rt(t))?nt({},c,t):c,null)}),!1},f=function(t,e){r()?n():t?n(t):(e&&c(e)&&(s(e)&&console.error("[router5][transition] Warning: state values changed during transition process."),a=e),u=u.slice(1),v())},v=function(){if(r())n();else{var t=l(f);t&&n(null,a)}};v()}function p(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function d(t,e,n,r,a){var o=!1,i=!1,c=t.getOptions(),s=t.getLifecycleFunctions(),l=ot(s,2),h=l[0],d=l[1],m=t.getMiddlewareFunctions(),g=function(){return o},y=function(){o||i||(o=!0,a({code:Y.TRANSITION_CANCELLED},null))},S=function(n,r){i=!0,g()||(!n&&c.autoCleanUp&&!function(){var n=u(e.name);Object.keys(h).forEach(function(e){n.indexOf(e)===-1&&t.clearCanDeactivate(e)})}(),a(n,r||e))},T=function(t,e){return at({},t,e instanceof Object?e:{error:e})},b=f(e,n),A=b.toDeactivate,O=b.toActivate,E={isCancelled:g,toState:e,fromState:n},P=function(t,e,n){var r=A.filter(function(t){return h[t]}).reduce(function(t,e){return at({},t,p({},e,h[e]))},{});v(r,at({},E,{errorKey:"segment"}),function(t){return n(t?T({code:Y.CANNOT_DEACTIVATE},t):null)})},R=function(t,e,n){var r=O.filter(function(t){return d[t]}).reduce(function(t,e){return at({},t,p({},e,d[e]))},{});v(r,at({},E,{errorKey:"segment"}),function(t){return n(t?T({code:Y.CANNOT_ACTIVATE},t):null)})},N=m.length?function(t,e,n){return v(m,at({},E),function(e,r){return n(e?T({code:Y.TRANSITION_ERR},e):null,r||t)})}:[],_=(n&&!r.forceDeactivate?[P]:[]).concat(R).concat(N);return v(_,E,S),y}function m(t){function e(){return o&&(o("navigate"),o=null),t}function n(){var e,r=arguments.length<=0?void 0:arguments[0],o=(e=arguments.length-1,arguments.length<=e?void 0:arguments[e]),i="function"==typeof o?o:ct,u="object"===ut(arguments.length<=1?void 0:arguments[1])?arguments.length<=1?void 0:arguments[1]:{},c="object"===ut(arguments.length<=2?void 0:arguments[2])?arguments.length<=2?void 0:arguments[2]:{};if(!t.isStarted())return void i({code:Y.ROUTER_NOT_STARTED});var s=t.buildState(r,u);if(!s){var l={code:Y.ROUTE_NOT_FOUND};return i(l),void t.invokeEventListeners(J.TRANSITION_ERROR,null,t.getState(),l)}var f=t.makeState(s.name,s.params,t.buildPath(r,u),s._meta),h=!!t.getState()&&t.areStatesEqual(t.getState(),f,!1);if(h&&!c.reload){var v={code:Y.SAME_STATES};return i(v),void t.invokeEventListeners(J.TRANSITION_ERROR,f,t.getState(),v)}var p=h?null:t.getState();return a(f,p,c,function(e,r){if(e)if(e.redirect){var a=e.redirect,o=a.name,u=a.params;n(o,u,it({},c,{reload:!0}),i)}else i(e);else t.invokeEventListeners(J.TRANSITION_SUCCESS,r,p,c),i(null,r)})}function r(){var e="object"===ut(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:{},r=2===arguments.length?arguments.length<=1?void 0:arguments[1]:"function"==typeof(arguments.length<=0?void 0:arguments[0])?arguments.length<=0?void 0:arguments[0]:ct,a=t.getOptions();return a.defaultRoute?n(a.defaultRoute,a.defaultParams,e,r):function(){}}function a(n,r){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:ct;return e(),t.invokeEventListeners(J.TRANSITION_START,n,r),o=d(t,n,r,a,function(e,a){o=null,a=a||n,e?(e.code===Y.TRANSITION_CANCELLED?t.invokeEventListeners(J.TRANSITION_CANCEL,n,r):t.invokeEventListeners(J.TRANSITION_ERROR,n,r,e),i(e)):(t.setState(a),i(null,a))})}var o=void 0;t.navigate=n,t.navigateToDefault=r,t.transitionToState=a,t.cancel=e}function g(t){function e(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];return n.forEach(o),t}function n(){return i=[],u=[],t}function r(){return i}function a(){return u}function o(e){i.push(e),u.push(t.executeFactory(e))}var i=[],u=[];t.useMiddleware=e,t.getMiddlewareFactories=r,t.getMiddlewareFunctions=a,t.clearMiddleware=n}function y(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function S(t){function e(){return i}function n(){for(var e=arguments.length,n=Array(e),a=0;a<e;a++)n[a]=arguments[a];return n.forEach(r),t}function r(t){a(t)||(i.push(t),o(t))}function a(t){return i.filter(function(e){return e.pluginName===t||e.name===t}).length>0}function o(e){var n=t.executeFactory(e),r=st.map(function(e){if(n[e])return t.addEventListener(e.toLowerCase().replace(/^on/,"$$").replace(/transition/,"$$"),n[e])}).filter(Boolean);u.push.apply(u,y(r))}var i=[],u=[];t.usePlugin=n,t.hasPlugin=a,t.getPlugins=e}function T(t){function e(){return[i,u]}function n(){return[c,s]}function r(e,n){var r=lt(n);return i[e]=r,c[e]=t.executeFactory(r),t}function a(e){return i[e]=void 0,c[e]=void 0,t}function o(e,n){var r=lt(n);return u[e]=r,s[e]=t.executeFactory(r),t}var i={},u={},c={},s={};t.canDeactivate=r,t.canActivate=o,t.getLifecycleFactories=e,t.getLifecycleFunctions=n,t.clearCanDeactivate=a}function b(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function A(t,e){function n(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=ht({},t.getDependencies(),n),a=e(t.rootNode,t.getOptions(),r);a.useMiddleware.apply(a,b(t.getMiddlewareFactories())),a.usePlugin.apply(a,b(t.getPlugins()));var o=t.getLifecycleFactories(),i=ft(o,2),u=i[0],c=i[1];return Object.keys(u).forEach(function(t){return a.canDeactivate(t,u[t])}),Object.keys(c).forEach(function(t){return a.canActivate(t,c[t])}),a}t.clone=n}function O(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function E(t){function e(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];(w[t]||[]).forEach(function(t){return t.apply(void 0,n)})}function n(t,e){w[t]=w[t].filter(function(t){return t!==e})}function r(t,e){return w[t]=(w[t]||[]).concat(e),function(){return n(t,e)}}function a(t){t.canActivate&&I.canActivate(t.name,t.canActivate)}function u(t,e,n,r,a){var o={},i=function(t,e){return Object.defineProperty(o,t,{value:e,enumerable:!0})};if(i("name",t),i("params",e),i("path",n),r||a){var u={params:r};a&&(u.source=a),i("meta",u)}return o}function c(t){return u(J.UNKNOWN_ROUTE,{path:t},t,{})}function s(){return k}function l(t){k=t}function f(){return C}function h(t,e){return"useTrailingSlash"===t&&void 0!==e&&(C.trailingSlash=!0),C[t]=e,I}function v(t,e){return j[t]=e,I}function p(t){return Object.keys(t).forEach(function(e){j[e]=t[e]}),I}function d(){return j}function y(){return[I,d()]}function b(t){return t.apply(void 0,O(y()))}function P(t){return x.add(t,a),I}function R(t,e,n){return I.rootNode.addNode(t,e),n&&I.canActivate(t,n),I}var N=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},_=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},k=null,w={},j=_,C=vt({},pt);Object.keys(N).forEach(function(t){return h(t,N[t])});var I={rootNode:x,getOptions:f,setOption:h,getState:s,setState:l,makeState:u,makeNotFoundState:c,setDependency:v,setDependencies:p,getDependencies:d,add:P,addNode:R,executeFactory:b,addEventListener:r,removeEventListener:n,invokeEventListeners:e};o(I),S(I),g(I),T(I),i(I),m(I),A(I,E);var x=t instanceof H?t:new H("","",t,a);return I.rootNode=x,I}function P(){var t=function(){return console.group("Router transition")},e=function(){return console.groupEnd("Router transition")};return console.info("Router started"),{onStop:function(){console.info("Router stopped")},onTransitionStart:function(n,r){e(),t(),console.log("Transition started from state"),console.log(r),console.log("To state"),console.log(n)},onTransitionCancel:function(){console.warn("Transition cancelled")},onTransitionError:function(t,n,r){console.warn("Transition error with code "+r.code),e()},onTransitionSuccess:function(){console.log("Transition success"),e()}}}var R=function(t){return t.split("?")[0]},N=function(t){return t.split("?")[1]},_=/\[\]$/,k=function(t){return _.test(t)},w=function(t){return t.replace(_,"")},j=function(t){return t.split("&").reduce(function(t,e){var n=e.split("="),r=n[0],a=n[1];return t.concat(1===n.length?{name:r,value:!0}:{name:r,value:decodeURIComponent(a)})},[])},C=function(t){return t.reduce(function(t,e){var n=e.name,r=e.value,a=k(n),o=t[w(n)];return void 0===o?t[w(n)]=a?[r]:r:t[w(n)]=[].concat(o,r),t},{})},I=function(t){return t.filter(function(t){var e=t.value;return void 0!==e&&null!==e}).map(function(t){var e=t.name,n=t.value;return n===!0?e:e+"="+encodeURIComponent(n)}).join("&")},x=function(t,e){if(!t)return"";var n=j(t).filter(function(t){var n=t.name;return e.indexOf(w(n))===-1}),r=I(n);return r||""},U=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},$=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),D=function(t){return"("+(t?t.replace(/(^<|>$)/g,""):"[a-zA-Z0-9-_.~%':]+")+")"},L=[{name:"url-parameter",pattern:/^:([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(t){return new RegExp(D(t[2]))}},{name:"url-parameter-splat",pattern:/^\*([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/,regex:/([^\?]*)/},{name:"url-parameter-matrix",pattern:/^\;([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(<(.+?)>)?/,regex:function(t){return new RegExp(";"+t[1]+"="+D(t[2]))}},{name:"query-parameter-bracket",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})(?:\[\])/},{name:"query-parameter",pattern:/^(?:\?|&)(?:\:)?([a-zA-Z0-9-_]*[a-zA-Z0-9]{1})/},{name:"delimiter",pattern:/^(\/|\?)/,regex:function(t){return new RegExp("\\"+t[0])}},{name:"sub-delimiter",pattern:/^(\!|\&|\-|_|\.|;)/,regex:function(t){return new RegExp(t[0])}},{name:"fragment",pattern:/^([0-9a-zA-Z]+)/,regex:function(t){return new RegExp(t[0])}}],F=function(t){return void 0!==t&&null!==t},q=function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=L.some(function(r){var a=e.match(r.pattern);return!!a&&(n.push({type:r.name,match:a[0],val:a.slice(1,2),otherVal:a.slice(2),regex:r.regex instanceof Function?r.regex(a):r.regex}),a[0].length<e.length&&(n=t(e.substr(a[0].length),n)),!0)});if(!r)throw new Error("Could not parse path.");return n},M=function(t,e){return e?t.replace(/\\\/$/,"")+"(?:\\/)?":t},B=function(t,e){return e?/(\/)$/.test(t)?t:t+"(\\/|\\?|\\.|;|$)":t},Q=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";/\[\]$/.test(e)&&(e=w(e),n=[n]);var r=t[e];return void 0===r?t[e]=n:t[e]=Array.isArray(r)?r.concat(n):[r,n],t},z=function(t){var e=N(t);return e?C(j(e)):{}},Z=function(){function t(n){if(e(this,t),!n)throw new Error("Please supply a path");this.path=n,this.tokens=q(n),this.hasUrlParams=this.tokens.filter(function(t){return/^url-parameter/.test(t.type)}).length>0,this.hasSpatParam=this.tokens.filter(function(t){return/splat$/.test(t.type)}).length>0,this.hasMatrixParams=this.tokens.filter(function(t){return/matrix$/.test(t.type)}).length>0,this.hasQueryParams=this.tokens.filter(function(t){return/^query-parameter/.test(t.type)}).length>0,this.spatParams=this._getParams("url-parameter-splat"),this.urlParams=this._getParams(/^url-parameter/),this.queryParams=this._getParams("query-parameter"),this.queryParamsBr=this._getParams("query-parameter-bracket"),this.params=this.urlParams.concat(this.queryParams).concat(this.queryParamsBr),this.source=this.tokens.filter(function(t){return void 0!==t.regex}).map(function(t){return t.regex.source}).join("")}return $(t,null,[{key:"createPath",value:function(e){return new t(e)}},{key:"serialise",value:function(t,e){return n(t,e)}}]),$(t,[{key:"_getParams",value:function(t){var e=t instanceof RegExp?function(e){return t.test(e.type)}:function(e){return e.type===t};return this.tokens.filter(e).map(function(t){return t.val[0]})}},{key:"_isQueryParam",value:function(t){return this.queryParams.indexOf(t)!==-1||this.queryParamsBr.indexOf(t)!==-1}},{key:"_urlTest",value:function(t,e){var n=this,r=t.match(e);return r?this.urlParams.length?r.slice(1,this.urlParams.length+1).reduce(function(t,e,r){return t[n.urlParams[r]]=decodeURIComponent(e),t},{}):{}:null}},{key:"test",value:function(t,e){var n=this,r=U({trailingSlash:!1},e),a=M(this.source,r.trailingSlash),o=this._urlTest(t,new RegExp("^"+a+(this.hasQueryParams?"(\\?.*$|$)":"$")));if(!o||!this.hasQueryParams)return o;var i=z(t),u=Object.keys(i).filter(function(t){return n.queryParams.concat(n.queryParamsBr).indexOf(t)===-1});return 0===u.length?(Object.keys(i).forEach(function(t){return o[t]=i[t]}),o):null}},{key:"partialTest",value:function(t,e){var n=this,r=U({delimited:!0},e),a=B(this.source,r.delimited),o=this._urlTest(t,new RegExp("^"+a));if(!o)return o;if(!this.hasQueryParams)return o;var i=z(t);return Object.keys(i).filter(function(t){return n.queryParams.concat(n.queryParamsBr).indexOf(t)>=0}).forEach(function(t){return Q(o,t,i[t])}),o}},{key:"build",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=U({ignoreConstraints:!1,ignoreSearch:!1},r),o=Object.keys(e).reduce(function(n,r){if(!F(e[r]))return n;var a=e[r],o=t._isQueryParam(r)?encodeURIComponent:encodeURI;return"boolean"==typeof a?n[r]=a:Array.isArray(a)?n[r]=a.map(o):n[r]=o(a),n},{});if(this.urlParams.some(function(t){return!F(o[t])}))throw new Error("Missing parameters");if(!a.ignoreConstraints){var i=this.tokens.filter(function(t){return/^url-parameter/.test(t.type)&&!/-splat$/.test(t.type)}).every(function(t){return new RegExp("^"+D(t.otherVal[0])+"$").test(o[t.val])});if(!i)throw new Error("Some parameters are of invalid format")}var u=this.tokens.filter(function(t){return/^query-parameter/.test(t.type)===!1}).map(function(t){return"url-parameter-matrix"===t.type?";"+t.val+"="+o[t.val[0]]:/^url-parameter/.test(t.type)?o[t.val[0]]:t.match}).join("");if(a.ignoreSearch)return u;var c=this.queryParams.concat(this.queryParamsBr.map(function(t){return t+"[]"})),s=c.filter(function(t){return Object.keys(o).indexOf(w(t))!==-1}).map(function(t){return n(t,o[w(t)])}).join("&");return u+(s?"?"+s:"")}}]),t}(),V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},K=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},W=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),G=function(){},H=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],o=arguments[3],i=arguments[4];return a(this,t),this.name=e,this.absolute=/^~/.test(n),this.path=this.absolute?n.slice(1):n,this.parser=this.path?new Z(this.path):null,this.children=[],this.parent=i,this.checkParents(),this.add(r,o),this}return W(t,[{key:"checkParents",value:function(){if(this.absolute&&this.haveParentsParams())throw new Error("[RouteNode] A RouteNode with an abolute path cannot have parents with route parameters")}},{key:"haveParentsParams",value:function(){if(this.parent&&this.parent.parser){var t=this.parent.parser,e=t.hasUrlParams||t.hasSpatParam||t.hasMatrixParams||t.hasQueryParams;return e||this.parent.haveParentsParams()}return!1}},{key:"getNonAbsoluteChildren",value:function(){return this.children.filter(function(t){return!t.absolute})}},{key:"findAbsoluteChildren",value:function(){return this.children.reduce(function(t,e){return t.concat(e.absolute?e:[]).concat(e.findAbsoluteChildren())},[])}},{key:"findSlashChild",value:function(){var t=this.getNonAbsoluteChildren().filter(function(t){return t.parser&&/^\/(\?|$)/.test(t.parser.path)});return t[0]}},{key:"getParentSegments",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return this.parent&&this.parent.parser?this.parent.getParentSegments(t.concat(this.parent)):t.reverse()}},{key:"setParent",value:function(t){this.parent=t,this.checkParents()}},{key:"setPath",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";this.path=t,this.parser=t?new Z(t):null}},{key:"add",value:function(e){var n=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:G,a=void 0;if(void 0!==e&&null!==e){if(e instanceof Array)return void e.forEach(function(t){return n.add(t,r)});if(!(e instanceof t||e instanceof Object))throw new Error("RouteNode.add() expects routes to be an Object or an instance of RouteNode.");if(e instanceof t)e.setParent(this);else{if(!e.name||!e.path)throw new Error("RouteNode.add() expects routes to have a name and a path defined.");a=e,e=new t(e.name,e.path,e.children,r,this)}var o=e.name.split(".");if(1===o.length){if(this.children.map(function(t){return t.name}).indexOf(e.name)!==-1)throw new Error('Alias "'+e.name+'" is already defined in route node');if(this.children.map(function(t){return t.path}).indexOf(e.path)!==-1)throw new Error('Path "'+e.path+'" is already defined in route node');this.children.push(e),this.children.sort(function(t,e){var n=t.path.split("?")[0].replace(/(.+)\/$/,"$1"),r=e.path.split("?")[0].replace(/(.+)\/$/,"$1");if("/"===n)return 1;if("/"===r)return-1;if(t.parser.hasSpatParam)return 1;if(e.parser.hasSpatParam)return-1;var a=(n.match(/\//g)||[]).length,o=(r.match(/\//g)||[]).length;if(a<o)return 1;if(a>o)return-1;var i=t.parser.urlParams.length,u=e.parser.urlParams.length;if(i<u)return-1;if(i>u)return 1;var c=(n.split("/").slice(-1)[0]||"").length,s=(r.split("/").slice(-1)[0]||"").length;return c<s?1:c>s?-1:0})}else{var i=this.getSegmentsByName(o.slice(0,-1).join("."));if(!i)throw new Error("Could not add route named '"+e.name+"', parent is missing.");i[i.length-1].add(new t(o[o.length-1],e.path,e.children))}if(a){var u=e.getParentSegments([e]).map(function(t){return t.name}).join(".");r(K({},a,{name:u}))}return this}}},{key:"addNode",value:function(e,n){return this.add(new t(e,n)),this}},{key:"getSegmentsByName",value:function(t){var e=function(t,e){var n=e.filter(function(e){return e.name===t});return n.length?n[0]:void 0},n=[],r=this.parser?[this]:this.children,a=(this.parser?[""]:[]).concat(t.split(".")),o=a.every(function(t){var a=e(t,r);return!!a&&(r=a.children,n.push(a),!0)});return o?n:null}},{key:"getSegmentsMatchingPath",value:function(t,e){var n=e.trailingSlash,r=e.strictQueryParams,a=e.strongMatching,o=function t(e,o,i){for(var u=1===e.length&&""===e[0].name,c=function(c){var s=e[c],l=void 0,f=void 0;if(s.children.length||(l=s.parser.test(o,{trailingSlash:n})),l||(l=s.parser.partialTest(o,{delimiter:a})),l){var h=s.parser.build(l,{ignoreSearch:!0});n&&!s.children.length&&(h=h.replace(/\/$/,"")),f=o.replace(h,"");var v=x(N(o.replace(h,"")),s.parser.queryParams.concat(s.parser.queryParamsBr));if(f=R(f)+(v?"?"+v:""),!n||u||"/"!==f||/\/$/.test(h)||(f=""),i.push(s),Object.keys(l).forEach(function(t){return i.params[t]=l[t]}),!u&&!f.length)return{v:i};if(!u&&!r&&0===f.indexOf("?")){var p=j(f.slice(1));return p.forEach(function(t){var e=t.name,n=t.value;return i.params[e]=n}),{v:i}}var d=s.getNonAbsoluteChildren();return d.length?{v:t(d,f,i)}:{v:null}}},s=0;s<e.length;s+=1){var l=c(s);if("object"===("undefined"==typeof l?"undefined":V(l)))return l.v}return null},i=this.parser?[this]:this.children,u=i.reduce(function(t,e){return t.concat(e,e.findAbsoluteChildren())},[]),c=[];c.params={};var s=o(u,t,c);return s&&1===s.length&&""===s[0].name?null:s}},{key:"getPathFromSegments",value:function(t){return t?t.map(function(t){return t.path}).join(""):null}},{key:"getPath",value:function(t){return this.getPathFromSegments(this.getSegmentsByName(t))}},{key:"buildPathFromSegments",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return null;var n=t.filter(function(t){return t.parser.hasQueryParams}).reduce(function(t,e){return t.concat(e.parser.queryParams).concat(e.parser.queryParamsBr.map(function(t){return t+"[]"}))},[]),r=n.length?n.filter(function(t){if(Object.keys(e).indexOf(w(t))===-1)return!1;var n=e[w(t)];return void 0!==n&&null!==n}).map(function(t){var n=e[w(t)],r=Array.isArray(n)?n.map(encodeURIComponent):encodeURIComponent(n);return Z.serialise(t,r)}).join("&"):null,a=t.reduce(function(t,n){var r=n.parser.build(e,{ignoreSearch:!0});return n.absolute?r:t+r},"");return a+(r?"?"+r:"")}},{key:"getMetaFromSegments",value:function(t){var e="";return t.reduce(function(t,n){var r=n.parser.urlParams.reduce(function(t,e){return t[e]="url",t},{}),a=n.parser.queryParams.reduce(function(t,e){return t[e]="query",t},r);return void 0!==n.name&&(e=e?e+"."+n.name:n.name,t[e]=a),t},{})}},{key:"buildPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.buildPathFromSegments(this.getSegmentsByName(t),e);return n.trailingSlash===!0?/\/$/.test(r)?r:r+"/":n.trailingSlash===!1&&/\/$/.test(r)?r.slice(0,-1):r}},{key:"buildStateFromSegments",value:function(t){if(!t||!t.length)return null;var e=t.map(function(t){return t.name}).filter(function(t){return t}).join("."),n=t.params;return{name:e,params:n,_meta:this.getMetaFromSegments(t)}}},{key:"buildState",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.getSegmentsByName(t);return n&&n.length?{name:t,params:e,_meta:this.getMetaFromSegments(n)}:null}},{key:"matchPath",value:function(t,e){var n={trailingSlash:!1,strictQueryParams:!0,strongMatching:!0},a=K({},n,e),o=this.getSegmentsMatchingPath(t,a);if(o){if(o[0].absolute){var i=o[0].getParentSegments();o.reverse(),o.push.apply(o,r(i)),o.reverse()}var u=o[o.length-1],c=u.findSlashChild();c&&o.push(c)}return this.buildStateFromSegments(o)}}]),t}(),Y={ROUTER_NOT_STARTED:"NOT_STARTED",NO_START_PATH_OR_STATE:"NO_START_PATH_OR_STATE",ROUTER_ALREADY_STARTED:"ALREADY_STARTED",ROUTE_NOT_FOUND:"ROUTE_NOT_FOUND",SAME_STATES:"SAME_STATES",CANNOT_DEACTIVATE:"CANNOT_DEACTIVATE",CANNOT_ACTIVATE:"CANNOT_ACTIVATE",TRANSITION_ERR:"TRANSITION_ERR",TRANSITION_CANCELLED:"CANCELLED"},J={UNKNOWN_ROUTE:"@@router5/UNKNOWN_ROUTE",ROUTER_START:"$start",ROUTER_STOP:"$stop",TRANSITION_START:"$$start",TRANSITION_CANCEL:"$$cancel",TRANSITION_SUCCESS:"$$success",TRANSITION_ERROR:"$$error"},X="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},tt=function(){},et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},nt=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},rt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},at=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},ot=function(){function t(t,e){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){a=!0,o=t}finally{try{!r&&u.return&&u.return()}finally{if(a)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),it=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ct=function(){},st=["onStart","onStop","onTransitionSuccess","onTransitionStart","onTransitionError","onTransitionCancel"],lt=function(t){return"function"==typeof t?t:function(){return function(){return t}}},ft=function(){function t(t,e){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){a=!0,o=t}finally{try{!r&&u.return&&u.return()}finally{if(a)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),ht=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},vt=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},pt={trailingSlash:0,useTrailingSlash:void 0,autoCleanUp:!0,strictQueryParams:!0,allowNotFound:!1,strongMatching:!0};P.pluginName="LOGGER_PLUGIN",t.default=E,t.createRouter=E,t.RouteNode=H,t.loggerPlugin=P,t.errorCodes=Y,t.transitionPath=f,t.constants=J,Object.defineProperty(t,"__esModule",{value:!0})});
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define('router5BrowserPlugin', factory) :
    (global.router5BrowserPlugin = factory());
}(this, (function () { 'use strict';

var errorCodes = {
    ROUTER_NOT_STARTED: 'NOT_STARTED',
    NO_START_PATH_OR_STATE: 'NO_START_PATH_OR_STATE',
    ROUTER_ALREADY_STARTED: 'ALREADY_STARTED',
    ROUTE_NOT_FOUND: 'ROUTE_NOT_FOUND',
    SAME_STATES: 'SAME_STATES',
    CANNOT_DEACTIVATE: 'CANNOT_DEACTIVATE',
    CANNOT_ACTIVATE: 'CANNOT_ACTIVATE',
    TRANSITION_ERR: 'TRANSITION_ERR',
    TRANSITION_CANCELLED: 'CANCELLED'
};

var constants = {
    UNKNOWN_ROUTE: '@@router5/UNKNOWN_ROUTE',
    ROUTER_START: '$start',
    ROUTER_STOP: '$stop',
    TRANSITION_START: '$$start',
    TRANSITION_CANCEL: '$$cancel',
    TRANSITION_SUCCESS: '$$success',
    TRANSITION_ERROR: '$$error'
};

/**
 * Dumb functions
 */
// istanbul ignore next
var identity = function identity(arg) {
    return function () {
        return arg;
    };
};
// istanbul ignore next
var noop = function noop() {};

/**
 * Browser detection
 */
var isBrowser = typeof window !== 'undefined' && window.history;

/**
 * Browser functions needed by router5
 */
var getBase = function getBase() {
    return window.location.pathname.replace(/\/$/, '');
};

var pushState = function pushState(state, title, path) {
    return window.history.pushState(state, title, path);
};

var replaceState = function replaceState(state, title, path) {
    return window.history.replaceState(state, title, path);
};

var addPopstateListener = function addPopstateListener(fn) {
    return window.addEventListener('popstate', fn);
};

var removePopstateListener = function removePopstateListener(fn) {
    return window.removeEventListener('popstate', fn);
};

var getLocation = function getLocation(opts) {
    var path = opts.useHash ? window.location.hash.replace(new RegExp('^#' + opts.hashPrefix), '') : window.location.pathname.replace(new RegExp('^' + opts.base), '');
    return (path || '/') + window.location.search;
};

var getState = function getState() {
    return window.history.state;
};

/**
 * Export browser object
 */
var browser = {};
if (isBrowser) {
    browser = { getBase: getBase, pushState: pushState, replaceState: replaceState, addPopstateListener: addPopstateListener, removePopstateListener: removePopstateListener, getLocation: getLocation, getState: getState };
} else {
    // istanbul ignore next
    browser = {
        getBase: identity(''),
        pushState: noop,
        replaceState: noop,
        addPopstateListener: noop,
        removePopstateListener: noop,
        getLocation: identity(''),
        getState: identity(null)
    };
}

var safeBrowser = browser;

function withUtils(router, options) {
    router.urlToPath = urlToPath;
    router.buildUrl = buildUrl;
    router.matchUrl = matchUrl;

    function buildUrl(route, params) {
        var base = options.base || '';
        var prefix = options.useHash ? '#' + options.hashPrefix : '';
        var path = router.buildPath(route, params);

        return base + prefix + path;
    }

    function urlToPath(url) {
        var match = url.match(/^(?:http|https)\:\/\/(?:[0-9a-z_\-\.\:]+?)(?=\/)(.*)$/);
        var path = match ? match[1] : url;

        var pathParts = path.match(/^(.+?)(#.+?)?(\?.+)?$/);

        if (!pathParts) throw new Error('[router5] Could not parse url ' + url);

        var pathname = pathParts[1];
        var hash = pathParts[2] || '';
        var search = pathParts[3] || '';

        return (options.useHash ? hash.replace(new RegExp('^#' + options.hashPrefix), '') : options.base ? pathname.replace(new RegExp('^' + options.base), '') : pathname) + search;
    }

    function matchUrl(url) {
        return router.matchPath(urlToPath(url));
    }
}

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var defaultOptions = {
    forceDeactivate: true,
    useHash: false,
    hashPrefix: '',
    base: false
};

var source = 'popstate';

function browserPluginFactory() {
    var opts = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
    var browser = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : safeBrowser;

    var options = _extends({}, defaultOptions, opts);
    var transitionOptions = { forceDeactivate: options.forceDeactivate, source: source };

    function browserPlugin(router) {
        var routerOptions = router.getOptions();
        var routerStart = router.start;

        withUtils(router, options);

        router.start = function () {
            for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
                args[_key] = arguments[_key];
            }

            if (args.length === 0 || typeof args[0] === 'function') {
                routerStart.apply(undefined, [browser.getLocation(options)].concat(args));
            } else {
                routerStart.apply(undefined, args);
            }

            return router;
        };

        router.replaceHistoryState = function (name) {
            var params = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

            var state = router.buildState(name, params);
            var url = router.buildUrl(name, params);
            router.lastKnownState = state;
            browser.replaceState(state, '', url);
        };

        function updateBrowserState(state, url, replace) {
            if (replace) browser.replaceState(state, '', url);else browser.pushState(state, '', url);
        }

        function onPopState(evt) {
            var routerState = router.getState();
            // Do nothing if no state or if last know state is poped state (it should never happen)
            var newState = !evt.state || !evt.state.name;
            var state = newState ? router.matchPath(browser.getLocation(options), source) : evt.state;
            var defaultRoute = routerOptions.defaultRoute,
                defaultParams = routerOptions.defaultParams;


            if (!state) {
                // If current state is already the default route, we will have a double entry
                // Navigating back and forth will emit SAME_STATES error
                defaultRoute && router.navigateToDefault(_extends({}, transitionOptions, { reload: true, replace: true }));
                return;
            }
            if (routerState && router.areStatesEqual(state, routerState, false)) {
                return;
            }

            router.transitionToState(state, routerState, transitionOptions, function (err, toState) {
                if (err) {
                    if (err.redirect) {
                        var _err$redirect = err.redirect,
                            name = _err$redirect.name,
                            params = _err$redirect.params;


                        router.navigate(name, params, _extends({}, transitionOptions, { replace: true }));
                    } else if (err === errorCodes.CANNOT_DEACTIVATE) {
                        var url = router.buildUrl(routerState.name, routerState.params);
                        if (!newState) {
                            // Keep history state unchanged but use current URL
                            updateBrowserState(state, url, true);
                        }
                        // else do nothing or history will be messed up
                        // TODO: history.back()?
                    } else {
                        // Force navigation to default state
                        defaultRoute && router.navigate(defaultRoute, defaultParams, _extends({}, transitionOptions, { reload: true, replace: true }));
                    }
                } else {
                    router.invokeEventListeners(constants.TRANSITION_SUCCESS, toState, routerState, { replace: true });
                }
            });
        }

        function onStart() {
            if (options.useHash && !options.base) {
                // Guess base
                options.base = browser.getBase();
            }

            browser.addPopstateListener(onPopState);
        }

        function onStop() {
            browser.removePopstateListener(onPopState);
        }

        function onTransitionSuccess(toState, fromState, opts) {
            var historyState = browser.getState();
            var replace = opts.replace || fromState && router.areStatesEqual(toState, fromState, false) || opts.reload && historyState && router.areStatesEqual(toState, historyState, false);
            updateBrowserState(toState, router.buildUrl(toState.name, toState.params), replace);
        }

        return { onStart: onStart, onStop: onStop, onTransitionSuccess: onTransitionSuccess, onPopState: onPopState };
    }

    browserPlugin.pluginName = 'BROWSER_PLUGIN';

    return browserPlugin;
}

return browserPluginFactory;

})));
(function (global, factory) {
    typeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :
    typeof define === 'function' && define.amd ? define('router5ListenersPlugin', factory) :
    (global.router5ListenersPlugin = factory());
}(this, (function () { 'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

function nameToIDs(name) {
    return name.split('.').reduce(function (ids, name) {
        return ids.concat(ids.length ? ids[ids.length - 1] + '.' + name : name);
    }, []);
}

function exists(val) {
    return val !== undefined && val !== null;
}

function hasMetaParams(state) {
    return state && state.meta && state.meta.params;
}

function extractSegmentParams(name, state) {
    if (!exists(state.meta.params[name])) return {};

    return Object.keys(state.meta.params[name]).reduce(function (params, p) {
        params[p] = state.params[p];
        return params;
    }, {});
}

function transitionPath(toState, fromState) {
    var fromStateIds = fromState ? nameToIDs(fromState.name) : [];
    var toStateIds = nameToIDs(toState.name);
    var maxI = Math.min(fromStateIds.length, toStateIds.length);

    function pointOfDifference() {
        var i = void 0;

        var _loop = function _loop() {
            var left = fromStateIds[i];
            var right = toStateIds[i];

            if (left !== right) return {
                    v: i
                };

            var leftParams = extractSegmentParams(left, toState);
            var rightParams = extractSegmentParams(right, fromState);

            if (leftParams.length !== rightParams.length) return {
                    v: i
                };
            if (leftParams.length === 0) return 'continue';

            var different = Object.keys(leftParams).some(function (p) {
                return rightParams[p] !== leftParams[p];
            });
            if (different) {
                return {
                    v: i
                };
            }
        };

        for (i = 0; i < maxI; i += 1) {
            var _ret = _loop();

            switch (_ret) {
                case 'continue':
                    continue;

                default:
                    if ((typeof _ret === 'undefined' ? 'undefined' : _typeof(_ret)) === "object") return _ret.v;
            }
        }

        return i;
    }

    var i = void 0;
    if (!fromState) {
        i = 0;
    } else if (!hasMetaParams(fromState) && !hasMetaParams(toState)) {
        console.warn('[router5.transition-path] Some states are missing metadata, reloading all segments');
        i = 0;
    } else {
        i = pointOfDifference();
    }

    var toDeactivate = fromStateIds.slice(i).reverse();
    var toActivate = toStateIds.slice(i);

    var intersection = fromState && i > 0 ? fromStateIds[i - 1] : '';

    return {
        intersection: intersection,
        toDeactivate: toDeactivate,
        toActivate: toActivate
    };
}

var defaultOptions = {
    autoCleanUp: true
};

function listenersPluginFactory() {
    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : defaultOptions;

    function listenersPlugin(router) {
        var listeners = {};

        function removeListener(name, cb) {
            if (cb) {
                if (listeners[name]) listeners[name] = listeners[name].filter(function (callback) {
                    return callback !== cb;
                });
            } else {
                listeners[name] = [];
            }
            return router;
        }

        function addListener(name, cb, replace) {
            var normalizedName = name.replace(/^(\*|\^|=)/, '');

            if (normalizedName && !/^\$/.test(name)) {
                var segments = router.rootNode.getSegmentsByName(normalizedName);
                if (!segments) console.warn('No route found for ' + normalizedName + ', listener might never be called!');
            }

            if (!listeners[name]) listeners[name] = [];
            listeners[name] = (replace ? [] : listeners[name]).concat(cb);

            return router;
        }

        router.getListeners = function () {
            return listeners;
        };

        router.addListener = function (cb) {
            return addListener('*', cb);
        };
        router.removeListener = function (cb) {
            return removeListener('*', cb);
        };

        router.addNodeListener = function (name, cb) {
            return addListener('^' + name, cb, true);
        };
        router.removeNodeListener = function (name, cb) {
            return removeListener('^' + name, cb);
        };

        router.addRouteListener = function (name, cb) {
            return addListener('=' + name, cb);
        };
        router.removeRouteListener = function (name, cb) {
            return removeListener('=' + name, cb);
        };

        function invokeListeners(name, toState, fromState) {
            (listeners[name] || []).forEach(function (cb) {
                if (listeners[name].indexOf(cb) !== -1) {
                    cb(toState, fromState);
                }
            });
        }

        function onTransitionSuccess(toState, fromState, opts) {
            var _transitionPath = transitionPath(toState, fromState),
                intersection = _transitionPath.intersection,
                toDeactivate = _transitionPath.toDeactivate;

            var intersectionNode = opts.reload ? '' : intersection;
            var name = toState.name;


            if (options.autoCleanUp) {
                toDeactivate.forEach(function (name) {
                    return removeListener('^' + name);
                });
            }

            invokeListeners('^' + intersectionNode, toState, fromState);
            invokeListeners('=' + name, toState, fromState);
            invokeListeners('*', toState, fromState);
        }

        return { onTransitionSuccess: onTransitionSuccess };
    }

    listenersPlugin.pluginName = 'LISTENERS_PLUGIN';

    return listenersPlugin;
}

return listenersPluginFactory;

})));
